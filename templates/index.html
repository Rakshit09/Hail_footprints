{% extends "base.html" %}

{% block content %}
<div id="pageRoot" data-max-upload-bytes="{{ max_upload_bytes }}" data-accepted-ext="{{ allowed_ext | join(',') }}">

    <!-- Main Card -->
    <div class="bg-white main-card overflow-hidden">

        <!-- Header Section -->
        <header class="header-gradient">
            <!-- Top Bar -->
            <div class="flex justify-between items-center px-8 lg:px-12 py-6">
                <div class="flex items-center gap-6">
                    <!-- Logo -->
                    <div class="logo-container flex-shrink-0">
                        <img src="{{ url_for('static', filename='logo.png') }}" alt="Hail Footprint Logo"
                            class="h-24 lg:h-32 w-auto object-contain transition-transform duration-300 hover:scale-105"
                            onerror="this.style.display='none'">
                    </div>

                    <!-- Divider -->
                    <div
                        class="hidden sm:block h-14 w-px bg-gradient-to-b from-transparent via-gray-300 to-transparent">
                    </div>

                    <!-- Title Block -->
                    <div class="space-y-2">
                        <h1 class="text-2xl lg:text-3xl font-bold text-black">
                            Hail Footprint Generator
                        </h1>
                        <p class="text-sm text-gray-500 flex items-center gap-2">
                            <i class="bi bi-geo-alt text-brand-blue"></i>
                            Generate hail footprints with geo-visualization from CSV data
                        </p>
                    </div>
                </div>

                <!-- Status Badge -->
                <div
                    class="flex items-center gap-2.5 px-4 py-2.5 bg-emerald-50 border border-emerald-200 rounded-full shadow-sm">
                    <span class="relative flex h-2.5 w-2.5">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span>
                    </span>
                    <span class="text-sm font-semibold text-emerald-700">Ready</span>
                </div>
            </div>
        </header>

        <!-- Brand Divider -->
        <div class="h-1 bg-gradient-to-r from-brand-blue via-brand-accent to-brand-blue"></div>

        <!-- Upload Section -->
        <section id="uploadSection" class="px-6 lg:px-12 py-10 bg-gradient-to-b from-gray-50/80 to-white">

            <!-- Section Header - Left Aligned -->
            <div class="flex items-center gap-4 mb-8">
                <div
                    class="flex items-center justify-center w-12 h-12 rounded-xl bg-gradient-to-br from-brand-blue/20 to-brand-accent/20 shadow-sm">
                    <i class="bi bi-database-add text-3xl text-brand-blue"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-brand-dark tracking-wide">Data Upload</h2>
                </div>
            </div>

            <!-- Upload Area - Centered -->
            <div class="max-w-2xl mx-auto">

                <!-- Hidden File Input -->
                <input type="file" id="fileInput" class="hidden" accept=".csv,.gpkg,.geojson,.shp">

                <!-- File Pill (shown after upload) -->
                <div id="filePill" class="hidden mb-8 animate-fade-in">
                    <div
                        class="flex items-center justify-between gap-4 p-4 bg-white border border-emerald-200 rounded-2xl shadow-sm shadow-emerald-100">
                        <div class="flex items-center gap-4">
                            <!-- File Icon -->
                            <div
                                class="w-20 h-20 rounded-xl bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center shadow-md shadow-emerald-200">
                                <i class="bi bi-file-earmark-check text-white text-2xl"></i>
                            </div>
                            <!-- File Info -->
                            <div>
                                <div class="font-semibold text-gray-800" id="filePillName">filename.csv</div>
                                <div class="flex items-center gap-2 text-sm text-gray-500">
                                    <span id="filePillMeta" class="font-mono"></span>
                                    <span
                                        class="inline-flex items-center gap-1 px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded-full text-xs font-medium">
                                        <i class="bi bi-check-circle-fill text-[10px]"></i>
                                        Ready
                                    </span>
                                </div>
                            </div>
                        </div>
                        <!-- Actions -->
                        <div class="flex items-center gap-2">
                            <button id="changeFileBtn"
                                class="flex items-center gap-2 px-4 py-2 bg-gray-100 border border-gray-200 rounded-xl font-medium text-sm text-gray-600 hover:bg-gray-200 hover:border-gray-300 transition-all duration-200">
                                <i class="bi bi-arrow-repeat"></i>
                                Change
                            </button>
                            <button id="removeFileBtn"
                                class="flex items-center justify-center w-10 h-10 rounded-xl text-gray-400 hover:bg-red-50 hover:text-red-500 transition-all duration-200"
                                title="Remove file">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Dropzone -->
                <div id="dropzone"
                    class="dropzone group cursor-pointer bg-white border-2 border-dashed border-gray-300 hover:border-brand-blue hover:bg-brand-blue/5 rounded-2xl transition-all duration-300 ease-out relative overflow-hidden">
                    <div class="flex flex-col items-center py-12 px-8 text-center">

                        <!-- Icon -->
                        <div class="relative mb-5">
                            <div
                                class="w-20 h-20 rounded-2xl bg-gradient-to-br from-brand-blue to-brand-accent flex items-center justify-center text-white shadow-xl shadow-brand-blue/25 transition-all duration-300 group-hover:scale-110 group-hover:shadow-2xl group-hover:shadow-brand-blue/30">
                                <i class="bi bi-cloud-arrow-up text-4xl"></i>
                            </div>
                            <div
                                class="absolute -bottom-1 -right-1 w-7 h-7 bg-white rounded-full flex items-center justify-center shadow-lg border-2 border-gray-100">
                                <i class="bi bi-plus-lg text-brand-blue font-bold"></i>
                            </div>
                        </div>

                        <!-- Text -->
                        <div class="mb-5">
                            <h3 class="text-lg font-bold text-brand-dark mb-1">
                                Drop your file here
                            </h3>
                            <p class="text-sm text-gray-500">
                                or <span
                                    class="text-brand-blue font-semibold cursor-pointer hover:underline">browse</span>
                                to choose from your computer
                            </p>
                        </div>

                        <!-- Supported Formats -->
                        <div class="flex flex-wrap items-center justify-center gap-2 mb-4">
                            <div
                                class="flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                                <i class="bi bi-filetype-csv text-gray-500"></i>
                                <span class="text-xs font-semibold text-gray-600">CSV</span>
                            </div>
                            <div
                                class="flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                                <i class="bi bi-file-earmark text-gray-500"></i>
                                <span class="text-xs font-semibold text-gray-600">GPKG</span>
                            </div>
                            <div
                                class="flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                                <i class="bi bi-braces text-gray-500"></i>
                                <span class="text-xs font-semibold text-gray-600">GeoJSON</span>
                            </div>
                            <div
                                class="flex items-center gap-1.5 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                                <i class="bi bi-file-earmark text-gray-500"></i>
                                <span class="text-xs font-semibold text-gray-600">SHP</span>
                            </div>
                        </div>

                        <div class="text-xs text-gray-400 flex items-center gap-1.5" id="fileHelp">
                            <i class="bi bi-info-circle"></i>
                            Maximum file size: {{ max_upload_mb }}MB
                        </div>

                        <!-- Upload Progress -->
                        <div id="uploadProgressWrap" class="mt-6 hidden w-full max-w-xs">
                            <div class="flex items-center justify-between text-xs text-gray-600 font-mono mb-2">
                                <span id="uploadProgressText">Processing…</span>
                                <span class="tabular-nums">—</span>
                            </div>
                            <div class="h-2 w-full overflow-hidden rounded-full bg-gray-200">
                                <div id="uploadProgressBar"
                                    class="h-full w-0 rounded-full bg-gradient-to-r from-brand-blue to-brand-accent transition-all duration-300">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Drag Active Overlay -->
                    <div id="dragOverlay"
                        class="hidden absolute inset-0 bg-brand-blue/10 border-2 border-brand-blue rounded-2xl flex items-center justify-center backdrop-blur-sm z-10">
                        <div class="text-center">
                            <div
                                class="w-16 h-16 mx-auto mb-3 rounded-full bg-brand-blue/20 flex items-center justify-center">
                                <i class="bi bi-bullseye text-4xl text-brand-blue"></i>
                            </div>
                            <p class="font-bold text-brand-blue text-lg">Release to upload</p>
                        </div>
                    </div>
                </div>

                <!-- Upload Error -->
                <div id="uploadError" class="mt-5 hidden animate-fade-in">
                    <div class="flex items-start gap-3 p-4 bg-red-50 border border-red-200 rounded-xl">
                        <div class="w-8 h-8 rounded-lg bg-red-100 flex items-center justify-center flex-shrink-0">
                            <i class="bi bi-exclamation-triangle text-red-500"></i>
                        </div>
                        <div class="text-sm text-red-700"></div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Configuration Section -->
    <div id="configSection" class="config-section mt-0" style="display: none;">
        <div class="bg-white main-card mt-6">

            <!-- Config Header -->
            <div class="config-header px-8 py-5 border-b border-gray-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-brand-dark flex items-center justify-center">
                        <i class="bi bi-sliders text-white text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-brand-dark">Configuration</h2>
                        <p class="text-sm text-gray-500">Map your columns and set processing parameters</p>
                    </div>
                </div>
            </div>

            <!-- Configuration Content -->
            <div class="p-8">

                <!-- Top Row: Settings + Data Preview -->
                <div class="grid lg:grid-cols-12 gap-6 items-start">

                    <!-- Left: Settings Column -->
                    <div class="lg:col-span-4 space-y-6" id="leftConfigColumn">

                        <!-- Column Mapping -->
                        <div class="config-group">
                            <div class="config-group-header">
                                <i class="bi bi-diagram-3 text-brand-blue"></i>
                                <span>Column Mapping</span>
                                <span
                                    class="ml-auto text-xs bg-brand-blue/10 text-brand-blue px-2 py-1 rounded-lg font-medium">Auto-detect</span>
                            </div>
                            <div class="space-y-4 p-5">
                                <div>
                                    <label class="input-label">Longitude <span class="text-red-500">*</span></label>
                                    <select id="lonCol" class="input-select"></select>
                                </div>
                                <div>
                                    <label class="input-label">Latitude <span class="text-red-500">*</span></label>
                                    <select id="latCol" class="input-select"></select>
                                </div>
                                <div>
                                    <label class="input-label">Hail Size <span class="text-red-500">*</span></label>
                                    <select id="hailCol" class="input-select"></select>
                                </div>
                                <div>
                                    <label class="input-label">QC Level <span
                                            class="text-gray-400 text-xs">(optional)</span></label>
                                    <select id="qcCol" class="input-select"></select>
                                </div>
                            </div>
                        </div>

                        <!-- Parameters -->
                        <div class="config-group">
                            <div class="config-group-header">
                                <i class="bi bi-gear text-brand-blue"></i>
                                <span>Parameters</span>
                            </div>
                            <div class="space-y-4 p-5">
                                <div>
                                    <label class="input-label">Event Name <span class="text-red-500">*</span></label>
                                    <input id="eventName" type="text" placeholder="Storm_20240115"
                                        class="input-field font-mono" />
                                </div>

                                <div>
                                    <label class="input-label">Proxy Hail Size <span
                                            class="text-gray-400 text-xs">(optional, used for missing
                                            values)</span></label>
                                    <input id="proxyHailSize" type="number" placeholder="e.g. 2.5" min="0" step="0.1"
                                        class="input-field font-mono" />
                                </div>

                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <label class="input-label text-[10px]">Group (km)</label>
                                        <input id="groupingThreshold" type="number" value="30" min="1" max="100"
                                            step="1" class="input-field font-mono text-center" />
                                    </div>
                                    <div>
                                        <label class="input-label text-[10px]">Large buf</label>
                                        <input id="largeBuffer" type="number" value="10" min="1" max="50" step="0.5"
                                            class="input-field font-mono text-center" />
                                    </div>
                                    <div>
                                        <label class="input-label text-[10px]">Small buf</label>
                                        <input id="smallBuffer" type="number" value="5" min="1" max="30" step="0.5"
                                            class="input-field font-mono text-center" />
                                    </div>
                                </div>

                                <button id="processBtn" disabled
                                    class="submit-btn w-full text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2 mt-2">
                                    <i class="bi bi-play-fill"></i>
                                    Generate Footprint
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Data Preview -->
                    <div class="lg:col-span-8" id="rightPreviewColumn">
                        <div class="config-group flex flex-col" id="dataPreviewCard">
                            <div class="config-group-header flex-shrink-0">
                                <i class="bi bi-table text-brand-blue"></i>
                                <span>Data Preview</span>
                                <span id="missingHailBadge"
                                    class="ml-2 px-2 py-0.5 rounded text-[10px] font-medium bg-red-50 text-red-700 border border-red-100 hidden">
                                    <span id="missingHailCount">0</span> rows missing Hail Size
                                </span>
                                <span id="qcIssueBadge"
                                    class="ml-2 px-2 py-0.5 rounded text-[10px] font-medium bg-amber-50 text-amber-700 border border-amber-100 hidden">
                                    <span id="qcIssueCount">0</span> rows QC ≠ 1
                                </span>
                            </div>
                            <div class="overflow-auto" id="previewTableContainer">
                                <table class="w-full">
                                    <thead id="previewThead"
                                        class="sticky top-0 bg-gray-50 text-xs uppercase tracking-wider text-gray-500">
                                    </thead>
                                    <tbody id="previewTbody" class="divide-y divide-gray-100 text-sm font-mono"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Panel (full width) -->
                <div id="processingPanel" class="mt-6 processing-panel" style="display:none;">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-full border-[3px] border-amber-200 border-t-amber-500 animate-spin">
                            </div>
                            <div>
                                <div class="text-lg font-semibold text-amber-800">Processing Your Data</div>
                                <div class="text-sm text-amber-600 font-mono" id="statusMessage">Initializing…</div>
                            </div>
                        </div>
                        <div class="text-4xl font-bold text-amber-700 font-mono" id="processingProgressLabel">0%</div>
                    </div>
                    <div class="mt-5 h-3 w-full overflow-hidden rounded-full bg-amber-100">
                        <div id="processingProgressBar"
                            class="h-full w-0 rounded-full bg-gradient-to-r from-amber-400 to-amber-500 transition-all duration-300">
                        </div>
                    </div>
                </div>

                <!-- Results Panel (full width) -->
                <div id="resultsPanel" class="mt-6 results-panel" style="display:none;">
                    <div
                        class="results-header flex items-center justify-between px-6 py-4 bg-gradient-to-r from-green-50 to-emerald-50 border-b border-green-100">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                                <i class="bi bi-check-circle-fill text-green-600 text-xl"></i>
                            </div>
                            <div>
                                <div class="text-lg font-semibold text-green-800">Results Ready</div>
                                <div class="text-sm text-green-600">Your hail footprint has been generated successfully
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- Buttons removed as per request -->
                        </div>
                    </div>

                    <div class="p-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="resultsSummaryCards">
                            <!-- Summary cards populated dynamically -->
                        </div>

                        <!-- Detailed Summary Table -->
                        <div class="mt-6 bg-gray-50 rounded-xl overflow-hidden">
                            <div class="px-5 py-3 border-b border-gray-200 bg-gray-100">
                                <div class="text-xs font-semibold uppercase tracking-wider text-gray-500">Detailed
                                    Summary</div>
                            </div>
                            <table class="w-full text-sm">
                                <tbody id="resultsSummaryBody" class="divide-y divide-gray-200">
                                    <!-- Results rows populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Viewer Section -->
    <div id="viewerSection" class="viewer-section mt-0" style="display: none;">
        <div class="bg-white main-card mt-6">

            <!-- Viewer Header -->
            <div class="flex items-center justify-between px-8 py-5 border-b border-gray-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-brand-dark flex items-center justify-center">
                        <i class="bi bi-map text-white text-lg"></i>
                    </div>
                    <div>
                        <h2 id="viewerTitle" class="text-lg font-semibold text-brand-dark">Interactive Map</h2>
                        <p class="text-sm text-gray-500">Pan, zoom, toggle layers, export</p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button id="exportCurrentViewBtn" class="action-btn">
                        <i class="bi bi-camera"></i>
                        HQ Export
                    </button>
                    <a id="viewerDownloadGeoJson" class="action-btn hidden" download>
                        <i class="bi bi-filetype-json"></i> GeoJSON
                    </a>
                    <a id="viewerDownloadGeoTiff" class="action-btn hidden" download>
                        <i class="bi bi-file-earmark-image"></i> GeoTIFF
                    </a>
                    <a id="viewerDownloadGridCsv" class="action-btn hidden" download>
                        <i class="bi bi-grid-3x3"></i> Grid CSV
                    </a>
                    <a id="viewerOpenNewTab" href="#" target="_blank" class="action-btn">
                        <i class="bi bi-box-arrow-up-right"></i> Open Map
                    </a>
                </div>
            </div>

            <!-- Map Container -->
            <div id="map-container" class="relative p-4">

                <!-- Loading Overlay -->
                <div id="loading-overlay"
                    class="absolute inset-4 z-[2000] flex items-center justify-center bg-white/95 rounded-2xl">
                    <div class="text-center">
                        <div
                            class="w-12 h-12 mx-auto rounded-full border-3 border-gray-200 border-t-brand-blue animate-spin">
                        </div>
                        <div class="mt-4 font-semibold text-brand-dark">Loading Map</div>
                        <div class="text-xs text-gray-500">Fetching data…</div>
                    </div>
                </div>

                <!-- Map -->
                <div id="map" class="rounded-2xl"></div>

                <!-- Quick Actions -->
                <div class="absolute left-8 top-8 z-[1000] flex flex-col gap-2">
                    <button class="map-btn" id="resetViewBtn" title="Reset View">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                    <button class="map-btn" id="toggleLayersBtn" title="Toggle Layers">
                        <i class="bi bi-layers"></i>
                    </button>
                    <button class="map-btn" id="togglePointsBtn" title="Toggle Points">
                        <i class="bi bi-geo-alt"></i>
                    </button>
                </div>

                <!-- Legend -->
                <div class="absolute bottom-8 right-8 z-[1000] legend-box">
                    <div class="mb-2 text-[10px] font-semibold uppercase tracking-wider text-gray-500">Hail Size (cm)
                    </div>
                    <div id="legendGradient" class="h-2.5 w-36 rounded-full"></div>
                    <div class="mt-1 flex justify-between text-[10px] text-gray-500 font-mono">
                        <span id="legendMin">0</span>
                        <span id="legendMax">1</span>
                    </div>
                </div>

                <!-- Hover Info -->
                <div class="absolute bottom-8 left-8 z-[1000] info-box">
                    <span class="text-xs text-gray-500">Hail:</span>
                    <span class="ml-1 text-xs font-semibold" id="hoverInfo">Hover over map</span>
                </div>
            </div>

            <!-- Horizontal Control Panel (Below Map) -->
            <!-- Horizontal Control Panel (Below Map) -->
            <div id="controlPanel"
                class="mx-2 mb-2 bg-white border border-gray-200 rounded-xl shadow-md transition-all duration-300">
                <div class="flex flex-wrap lg:flex-nowrap gap-3 p-3 text-sm">

                    <!-- HAIL LAYER -->
                    <div
                        class="flex-1 min-w-[200px] bg-gray-50/50 rounded-lg p-2 border border-gray-100 flex flex-col gap-2">
                        <label class="flex items-center gap-2 cursor-pointer select-none group mb-0.5">
                            <div
                                class="relative flex items-center justify-center w-7 h-7 bg-white rounded-lg border border-gray-200 group-hover:border-blue-300 transition-colors shadow-sm">
                                <input id="showFootprint" type="checkbox" checked
                                    class="peer absolute opacity-0 w-full h-full cursor-pointer z-10">
                                <i
                                    class="bi bi-grid-3x3 text-gray-400 text-base transition-all peer-checked:text-brand-blue"></i>
                            </div>
                            <span class="font-bold text-gray-700 text-sm">Hail Layer</span>
                        </label>

                        <!-- Options -->
                        <div id="footprintOptions" class="space-y-1.5 px-0.5">
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-gray-500 font-medium text-xs uppercase">Type</span>
                                <select id="displayMode"
                                    class="w-28 py-1 px-2 border border-gray-200 rounded bg-white text-gray-700 focus:border-brand-blue outline-none cursor-pointer text-xs">
                                    <option value="cells">Grid Cells</option>
                                    <option value="continuous">Continuous</option>
                                </select>
                            </div>

                            <!-- Grid Cell Options -->
                            <div id="cellOptions" class="space-y-1.5">
                                <label class="flex items-center gap-1.5 cursor-pointer select-none">
                                    <input id="showCellBorders" type="checkbox" checked
                                        class="accent-brand-blue w-3 h-3 cursor-pointer">
                                    <span class="text-gray-600 font-medium text-xs">Show Borders</span>
                                </label>

                                <div id="cellBorderOptions" class="grid grid-cols-2 gap-1.5">
                                    <!-- Width Input -->
                                    <div
                                        class="relative flex items-center bg-white border border-gray-200 rounded px-1.5 py-0.5">
                                        <span class="text-gray-400 text-xs mr-1">W:</span>
                                        <input id="cellBorderWidth" type="number" min="0.1" max="3" step="0.1"
                                            value="0.5"
                                            class="w-full text-center outline-none bg-transparent font-mono text-gray-700 text-xs">
                                    </div>
                                    <!-- Color Input -->
                                    <div class="h-full w-full">
                                        <input id="cellBorderColor" type="color" value="#666666"
                                            class="w-full h-[22px] rounded border border-gray-200 cursor-pointer p-0.5 bg-white">
                                    </div>
                                </div>
                            </div>

                            <!-- Continuous Options -->
                            <div id="continuousOptions" class="flex items-center gap-2" style="display:none;">
                                <span class="text-gray-500 text-xs w-12">Smooth</span>
                                <input id="smoothnessLevel" type="range" min="0" max="5" value="1"
                                    class="flex-1 accent-brand-blue h-1.5 bg-gray-200 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <!-- OUTLINE LAYER -->
                    <div
                        class="flex-1 min-w-[140px] bg-gray-50/50 rounded-lg p-2 border border-gray-100 flex flex-col gap-2">
                        <label class="flex items-center gap-2 cursor-pointer select-none group mb-0.5">
                            <div
                                class="relative flex items-center justify-center w-7 h-7 bg-white rounded-lg border border-gray-200 group-hover:border-purple-300 transition-colors shadow-sm">
                                <input id="showOutline" type="checkbox" checked
                                    class="peer absolute opacity-0 w-full h-full cursor-pointer z-10">
                                <i
                                    class="bi bi-bounding-box text-gray-400 text-base transition-all peer-checked:text-purple-600"></i>
                            </div>
                            <span class="font-bold text-gray-700 text-sm">Outline</span>
                        </label>

                        <div id="outlineOptions" class="space-y-1.5 px-0.5">
                            <div class="grid grid-cols-2 gap-1.5">
                                <!-- Width -->
                                <div class="col-span-2 flex items-center justify-between">
                                    <span class="text-gray-500 text-xs">Width</span>
                                    <input id="outlineWidth" type="number" min="0.5" max="10" step="0.5" value="1.5"
                                        class="w-14 py-0.5 px-1 border border-gray-200 rounded bg-white text-center font-mono text-gray-700 outline-none text-xs">
                                </div>
                                <!-- Color -->
                                <div class="col-span-2 flex items-center justify-between">
                                    <span class="text-gray-500 text-xs">Color</span>
                                    <input id="outlineColor" type="color" value="#000000"
                                        class="w-14 h-6 rounded border border-gray-200 cursor-pointer p-0.5 bg-white">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- POINTS LAYER (Expanded) -->
                    <div
                        class="flex-1 min-w-[140px] bg-gray-50/50 rounded-lg p-2 border border-gray-100 flex flex-col gap-2">
                        <label class="flex items-center gap-2 cursor-pointer select-none group mb-0.5">
                            <div
                                class="relative flex items-center justify-center w-7 h-7 bg-white rounded-lg border border-gray-200 group-hover:border-green-300 transition-colors shadow-sm">
                                <input id="showPoints" type="checkbox"
                                    class="peer absolute opacity-0 w-full h-full cursor-pointer z-10">
                                <i
                                    class="bi bi-geo-alt-fill text-gray-400 text-base transition-all peer-checked:text-green-500"></i>
                            </div>
                            <span class="font-bold text-gray-700 text-sm">Points</span>
                        </label>

                        <div id="pointOptions" class="space-y-1.5 px-0.5">
                            <!-- ID for JS hook if needed, strictly UI for now -->
                            <div class="grid grid-cols-2 gap-1.5">
                                <!-- Radius -->
                                <div class="col-span-2 flex items-center justify-between">
                                    <span class="text-gray-500 text-xs">Size</span>
                                    <input id="pointRadius" type="number" min="1" max="20" step="1" value="2"
                                        class="w-14 py-0.5 px-1 border border-gray-200 rounded bg-white text-center font-mono text-gray-700 outline-none text-xs">
                                </div>
                                <!-- Color -->
                                <div class="col-span-2 flex items-center justify-between">
                                    <span class="text-gray-500 text-xs">Color</span>
                                    <input id="pointColor" type="color" value="#ff7800"
                                        class="w-14 h-6 rounded border border-gray-200 cursor-pointer p-0.5 bg-white">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- COLORMAP -->
                    <div
                        class="flex-1 min-w-[180px] bg-gray-50/50 rounded-lg p-2 border border-gray-100 flex flex-col gap-2">
                        <div class="flex items-center gap-2 mb-0.5">
                            <i class="bi bi-palette text-orange-500 text-xs"></i>
                            <span class="font-bold text-gray-700 text-sm">Colormap</span>
                        </div>

                        <div class="space-y-1.5 px-0.5">
                            <select id="colorMapSelect"
                                class="w-full py-1 px-2 border border-gray-200 rounded bg-white text-gray-700 text-xs focus:border-brand-blue outline-none cursor-pointer">
                                <optgroup label="Sequential">
                                    <option value="ylOrRd" selected>Yellow-Orange-Red</option>
                                    <option value="orRd">Orange-Red</option>
                                    <option value="reds">Reds</option>
                                    <option value="ylGnBu">Yellow-Green-Blue</option>
                                    <option value="blues">Blues</option>
                                    <option value="greens">Greens</option>
                                    <option value="purples">Purples</option>
                                    <option value="greys">Greys</option>
                                </optgroup>
                                <optgroup label="Perceptually Uniform">
                                    <option value="viridis">Viridis</option>
                                    <option value="plasma">Plasma</option>
                                    <option value="inferno">Inferno</option>
                                    <option value="magma">Magma</option>
                                    <option value="cividis">Cividis</option>
                                    <option value="turbo">Turbo</option>
                                </optgroup>
                                <optgroup label="Classic">
                                    <option value="jet">Jet</option>
                                    <option value="hot">Hot</option>
                                    <option value="spectral">Spectral</option>
                                    <option value="coolwarm">Cool-Warm</option>
                                </optgroup>
                            </select>

                            <div id="colorMapPreview" class="h-1.5 w-full rounded-full border border-gray-200"></div>

                            <div class="flex items-center gap-2">
                                <span class="text-gray-500 text-xs uppercase w-12">Opacity</span>
                                <input id="opacitySlider" type="range" min="0.1" max="1" step="0.1" value="0.7"
                                    class="flex-1 accent-orange-500 h-1.5 bg-gray-200 rounded-lg">
                                <span id="opacityValue" class="font-mono font-bold text-orange-600 text-xs">0.7</span>
                            </div>
                        </div>
                    </div>

                    <!-- BASEMAP & COORDS -->
                    <div
                        class="flex-1 min-w-[140px] bg-gray-50/50 rounded-lg p-2 border border-gray-100 flex flex-col gap-2">
                        <div class="flex items-center gap-2 mb-0.5">
                            <i class="bi bi-map text-teal-600 text-xs"></i>
                            <span class="font-bold text-gray-700 text-sm">Basemap</span>
                        </div>

                        <div class="space-y-1.5 px-0.5 flex-1 flex flex-col">
                            <select id="basemapSelect"
                                class="w-full py-1 px-2 border border-gray-200 rounded bg-white text-gray-700 text-xs focus:border-brand-blue outline-none cursor-pointer">
                                <optgroup label="Light">
                                    <option value="carto_light" selected>Carto Light</option>
                                    <option value="carto_positron_nolabels">Carto Light (No Labels)</option>
                                    <option value="carto_voyager">Carto Voyager</option>
                                    <option value="osm">OpenStreetMap</option>
                                    <option value="esri_gray">ESRI Gray</option>
                                </optgroup>
                                <optgroup label="Dark">
                                    <option value="carto_dark">Carto Dark</option>
                                    <option value="esri_darkgray">ESRI Dark Gray</option>
                                </optgroup>
                                <optgroup label="Detailed">
                                    <option value="esri_worldstreet">ESRI World Street</option>
                                    <option value="esri_worldtopo">ESRI World Topo</option>
                                </optgroup>
                                <optgroup label="Imagery">
                                    <option value="esri_worldimagery">Satellite</option>
                                </optgroup>
                            </select>

                            <div
                                class="mt-auto pt-2 border-t border-gray-200 flex items-center justify-between text-xs text-gray-500">
                                <i class="bi bi-crosshair"></i>
                                <span id="coordsDisplay" class="font-mono">--,--</span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="errorContainer" class="px-8 pb-4"></div>
        </div>
    </div>
</div>

<!-- Hidden Form Data -->
<input type="hidden" id="uploadedFilename" value="">
<input type="hidden" id="jobId" value="">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/viewer.js') }}?v={{ range(1, 10000) | random }}"></script>
<script src="{{ url_for('static', filename='js/index.js') }}?v={{ range(1, 10000) | random }}"></script>
{% endblock %}