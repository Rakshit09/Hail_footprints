{% extends "base.html" %}

{% block title %}Map Viewer - {{ event_name }}{% endblock %}

{% block extra_css %}
<style>
  #map { height: calc(100vh - 280px); min-height: 600px; }
</style>
{% endblock %}

{% block content %}
<!-- Main Card -->
<div class="bg-white main-card">
    
    <!-- Header Section -->
    <div class="flex justify-between items-center px-8 py-6 header-gradient rounded-t-[20px]">
        
        <!-- Left: Back & Title -->
        <div class="flex items-center gap-6">
            <a href="{{ url_for('index') }}" class="action-btn">
                <i class="bi bi-arrow-left"></i>
                Back
            </a>
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-brand-dark flex items-center justify-center">
                    <i class="bi bi-map text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-brand-dark">{{ event_name }}</h1>
                    <p class="text-sm text-gray-500">Interactive map viewer</p>
                </div>
            </div>
        </div>

        <!-- Right: Export Buttons -->
        <div class="flex items-center gap-3">
            <button id="exportCurrentViewBtn" class="action-btn">
                <i class="bi bi-camera"></i>
                HQ Export
            </button>
            <button id="exportScreenshotBtn" class="action-btn">
                <i class="bi bi-image"></i>
                Screenshot
            </button>
            {% if result.geojson %}
            <a class="submit-btn text-white font-semibold px-5 py-2.5 rounded-xl flex items-center gap-2" href="{{ url_for('serve_output', job_id=job_id, filename=result.geojson) }}" download>
                <i class="bi bi-filetype-json"></i>
                GeoJSON
            </a>
            {% endif %}
            {% if result.footprint_png %}
            <a class="action-btn" href="{{ url_for('serve_output', job_id=job_id, filename=result.footprint_png) }}" download>
                <i class="bi bi-file-image"></i>
                PNG
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Brand Divider -->
    <div class="brand-divider h-1"></div>

    <!-- Map Container -->
    <div id="map-container" class="relative p-4">
        
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="absolute inset-4 z-[2000] flex items-center justify-center bg-white/95 rounded-2xl">
            <div class="text-center">
                <div class="w-12 h-12 mx-auto rounded-full border-3 border-gray-200 border-t-brand-blue animate-spin"></div>
                <div class="mt-4 font-semibold text-brand-dark">Loading Map</div>
                <div class="text-xs text-gray-500">Fetching dataâ€¦</div>
            </div>
        </div>

        <!-- Map -->
        <div id="map" class="rounded-2xl"></div>

        <!-- Quick Actions -->
        <div class="absolute left-8 top-8 z-[1000] flex flex-col gap-2">
            <button class="map-btn" id="resetViewBtn" title="Reset View">
                <i class="bi bi-arrows-fullscreen"></i>
            </button>
            <button class="map-btn" id="toggleLayersBtn" title="Toggle Layers">
                <i class="bi bi-layers"></i>
            </button>
            <button class="map-btn" id="togglePointsBtn" title="Toggle Points">
                <i class="bi bi-geo-alt"></i>
            </button>
        </div>

        <!-- Control Panel -->
        <div id="controlPanel" class="absolute right-8 top-8 z-[1000] w-[260px] control-panel">
            <div id="panelHeader" class="flex cursor-pointer items-center justify-between px-4 py-3 border-b border-gray-100 bg-gray-50/80">
                <div class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wider text-gray-600">
                    <i class="bi bi-sliders2"></i>
                    Controls
                </div>
                <button id="panelToggle" class="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-gray-200 transition">
                    <i class="bi bi-chevron-right text-xs" id="toggleIcon"></i>
                </button>
            </div>

            <div id="panelContent" class="space-y-4 p-4">
                <!-- Layers -->
                <div>
                    <div class="mb-3 text-[10px] font-semibold uppercase tracking-wider text-gray-400">Layers</div>
                    <div class="space-y-2">
                        <label class="flex cursor-pointer items-center justify-between rounded-lg p-2 hover:bg-gray-50 transition">
                            <span class="text-sm">Hail intensity</span>
                            <input id="showFootprint" type="checkbox" checked class="checkbox">
                        </label>
                        <label class="flex cursor-pointer items-center justify-between rounded-lg p-2 hover:bg-gray-50 transition">
                            <span class="text-sm">Outline</span>
                            <input id="showOutline" type="checkbox" checked class="checkbox">
                        </label>
                        <label class="flex cursor-pointer items-center justify-between rounded-lg p-2 hover:bg-gray-50 transition">
                            <span class="text-sm">Points</span>
                            <input id="showPoints" type="checkbox" class="checkbox">
                        </label>
                    </div>
                </div>

                <!-- Opacity -->
                <div class="border-t border-gray-100 pt-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] font-semibold uppercase tracking-wider text-gray-400">Opacity</span>
                        <span class="text-xs font-semibold text-gray-700" id="opacityValue">0.6</span>
                    </div>
                    <input id="opacitySlider" type="range" min="0.1" max="1" step="0.1" value="0.6" class="slider">
                </div>

                <!-- Basemap -->
                <div class="border-t border-gray-100 pt-4">
                    <div class="mb-2 text-[10px] font-semibold uppercase tracking-wider text-gray-400">Basemap</div>
                    <select id="basemapSelect" class="input-select text-sm">
                        <optgroup label="Light">
                            <option value="carto_light" selected>Carto Light</option>
                            <option value="carto_positron_nolabels">Carto (No Labels)</option>
                            <option value="osm">OpenStreetMap</option>
                            <option value="esri_gray">ESRI Gray</option>
                        </optgroup>
                        <optgroup label="Dark">
                            <option value="carto_dark">Carto Dark</option>
                            <option value="esri_darkgray">ESRI Dark Gray</option>
                        </optgroup>
                        <optgroup label="Detailed">
                            <option value="carto_voyager">Carto Voyager</option>
                            <option value="esri_worldstreet">ESRI Street</option>
                            <option value="esri_worldtopo">ESRI Topo</option>
                        </optgroup>
                        <optgroup label="Imagery">
                            <option value="esri_worldimagery">ESRI Satellite</option>
                        </optgroup>
                        <optgroup label="Other">
                            <option value="none">No basemap</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Coordinates -->
                <div class="border-t border-gray-100 pt-3">
                    <div class="text-[10px] text-gray-400 font-mono" id="coordsDisplay">
                        Move mouse over map
                    </div>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="absolute bottom-8 right-8 z-[1000] legend-box">
            <div class="mb-2 text-[10px] font-semibold uppercase tracking-wider text-gray-500">Hail Size (cm)</div>
            <div class="h-2.5 w-36 rounded-full bg-gradient-to-r from-[#ffffb2] via-[#fd8d3c] to-[#bd0026]"></div>
            <div class="mt-1 flex justify-between text-[10px] text-gray-500 font-mono">
                <span id="legendMin">0</span>
                <span id="legendMax">1</span>
            </div>
        </div>

        <!-- Hover Info -->
        <div class="absolute bottom-8 left-8 z-[1000] info-box">
            <span class="text-xs text-gray-500">Hail:</span>
            <span class="ml-1 text-xs font-semibold" id="hoverInfo">Hover over map</span>
        </div>
    </div>

    <div id="errorContainer" class="px-8 pb-4"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/viewer.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var jobId = {{ job_id | tojson | safe }};
    var eventName = {{ event_name | tojson | safe }};
    var result = {{ result | tojson | safe }};
    try {
      if (window.HailViewer && window.HailViewer.init) {
        window.HailViewer.init({ jobId: jobId, eventName: eventName, result: result });
      }
    } catch (e) {
      console.error(e);
      if (window.HailUI && window.HailUI.toast) {
        window.HailUI.toast(e.message, { type: 'error', title: 'Viewer failed' });
      }
    }
  });
</script>
{% endblock %}
